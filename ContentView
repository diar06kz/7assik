import SwiftUI

struct ContentView: View {
    @StateObject private var vm = WeatherViewModel()

    var body: some View {
        NavigationStack {
            VStack(spacing: 12) {
                header

                searchBar

                content

                Spacer(minLength: 8)
            }
            .padding()
            .navigationTitle("Weather")
            .toolbar {
                NavigationLink("Settings") { SettingsView(unit: $vm.unit) }
            }
        }
    }

    private var header: some View {
        VStack(alignment: .leading, spacing: 6) {
            Text("Search a city")
                .font(.title2).bold()
            Text("Shows current weather + 3-day forecast. Uses cache when offline.")
                .font(.subheadline)
                .foregroundStyle(.secondary)
        }
        .frame(maxWidth: .infinity, alignment: .leading)
    }

    private var searchBar: some View {
        HStack(spacing: 8) {
            TextField("e.g., Astana", text: $vm.query)
                .textInputAutocapitalization(.words)
                .autocorrectionDisabled()
                .textFieldStyle(.roundedBorder)

            Button("Search") { vm.search() }
                .buttonStyle(.borderedProminent)
        }
    }

    @ViewBuilder
    private var content: some View {
        switch vm.state {
        case .idle:
            EmptyStateView()
        case .loading:
            HStack(spacing: 10) {
                ProgressView()
                Text("Loading...")
            }
            .frame(maxWidth: .infinity, alignment: .leading)

        case .error(let message):
            ErrorStateView(message: message) {
                vm.search()
            }

        case .loaded(let result):
            WeatherCardView(result: result, unitSymbol: vm.unit.symbol)
        }
    }
}

struct EmptyStateView: View {
    var body: some View {
        VStack(alignment: .leading, spacing: 8) {
            Text("Enter a city name and tap Search.")
            Text("Tip: Try turning off Wi-Fi later to test offline mode (cached data).")
                .foregroundStyle(.secondary)
                .font(.subheadline)
        }
        .frame(maxWidth: .infinity, alignment: .leading)
        .padding(.top, 8)
    }
}

struct ErrorStateView: View {
    let message: String
    let retry: () -> Void

    var body: some View {
        VStack(alignment: .leading, spacing: 10) {
            Text("Error")
                .font(.headline)
            Text(message)
                .foregroundStyle(.secondary)

            Button("Retry", action: retry)
                .buttonStyle(.bordered)
        }
        .frame(maxWidth: .infinity, alignment: .leading)
        .padding(.top, 8)
    }
}

